name: Sync to Hugging Face Spaces
on:
  push:
    branches: [main, vatsal-dev]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Deploy to Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git config --global user.email "bot@github.com"
          git config --global user.name "GitHub Action Bot"
          
          # Clone the HF Space using token in URL for authentication
          git clone https://vats147:$HF_TOKEN@huggingface.co/spaces/vats147/bianance-bot hf_space
          
          # Clean HF space (except .git)
          find hf_space -maxdepth 1 -not -name 'hf_space' -not -name '.git' -exec rm -rf {} +
          
          # Copy backend files, ensuring we don't copy local .git or __pycache__
          rsync -av --exclude '.git' --exclude '__pycache__' --exclude '.env' backend/ hf_space/
          
          cd hf_space
          
          # Add a simple .gitignore to the Space if it doesn't exist
          if [ ! -f .gitignore ]; then
            echo "__pycache__/" > .gitignore
            echo "*.pyc" >> .gitignore
            echo ".env" >> .gitignore
          fi
          
          git add .
          git commit -m "Sync from GitHub: ${{ github.sha }}" || echo "No changes to commit"
          git push origin main
